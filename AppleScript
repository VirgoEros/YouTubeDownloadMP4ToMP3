(* 
bit.ly/ä¸‹è¼‰_é±«é°°YouTubeè¦–é »ä¸‹è¼‰é±®MP4è½‰æ›MP3_DMG 
GitHub.com/VirgoEros/YouTubeDownloadMP4ToMP3/blob/master/AppleScript 
*)
-----------------âˆ é±«é°°YouTubeè¦–é »ä¸‹è¼‰é±®MP4è½‰æ›MP3 âˆ--------------------------ON. 
global VideoDownloadConversion, UpdateYouTubeDL, YouTubeVideoDownloads, InstallYouTubeDl, UpdateFFmpeg, VideoConversion, errmsg, errnbr
global InstallYouTubeDl, YouTubeDl_Path, isDone, itemPath, itemProgress, APPmacOSPath, YouTubeVideoDownloads, errmsg, errnbr
global YouTubeVideoDownloads, VideoURL, APPitemPath, inBackground, YouTubeURL, DownloadDestination, isDone, itemPath, itemProgress, errmsg, errnbr
global VideoConversion, ConversionOption, SinglePiece, BatchConversion, errmsg, errnbr
global SinglePiece, Input, BitConversion, APPitemPath, InputPath, InputPath1, mk, Output, ConversionParameter, FFmpegConversion, inBackground, FFmpeg, remove_path, oldDelims, this_name, remove_extension, isDone, MP3_Folder, itemPath, itemProgress, errmsg, errnbr
global BatchConversion, Input, media, BitConversion, APPitemPath, Input1, Input2, mk, fileName, Output, ConversionParameter, FFmpegConversion, inBackground, FFmpeg, isDone, MP3_Folder, itemPath, itemProgress, errmsg, errnbr, oldDelims, this_name, remove_extension
global InstallFFmpeg, me_Path, MacOS_Path, FFmpeg, isDone, itemPath, itemProgress, errmsg, errnbr
global OpenScript, OpenAppScript, errmsg, errnbr

on run
	try
		tell application "Finder" to set {button returned:VideoDownloadConversion} to Â¬
			display dialog {"è«‹åš«é±«çš„æ²å¥³é°°é¸æ“‡ YouTubeè¦–é »ä¸‹è¼‰ é±® MP4è½‰æ›MP3é¸é …å”·ğŸ’‹"} buttons Â¬
				{"YouTubeè¦–é »ä¸‹è¼‰ & é¯æ–°YouTube-Dl", "MP4è½‰æ›MP3 & é¯æ–° FFmpeg", "é–‹å•Ÿè…³æœ¬"} default button 1 with title Â¬
				{"YouTubeè¦–é »ä¸‹è¼‰"}
		if VideoDownloadConversion is "YouTubeè¦–é »ä¸‹è¼‰ & é¯æ–°YouTube-Dl" then
			tell application "Finder" to set {button returned:UpdateYouTubeDL} to Â¬
				display dialog ("è«‹åš«é±«çš„æ²å¥³é°°é¸æ“‡ YouTubeè¦–é »ä¸‹è¼‰é¸é …å”·ğŸ’‹") buttons Â¬
					{"YouTubeè¦–é »ä¸‹è¼‰", "é¯æ–°YouTube-Dl"} default button 1 with title Â¬
					{"YouTubeè¦–é »ä¸‹è¼‰"}
			if UpdateYouTubeDL is "YouTubeè¦–é »ä¸‹è¼‰" then run script YouTubeVideoDownloads
			if UpdateYouTubeDL is "é¯æ–°YouTube-Dl" then run script InstallYouTubeDl
		end if
		if VideoDownloadConversion is "MP4è½‰æ›MP3 & é¯æ–° FFmpeg" then
			tell application "Finder" to set {button returned:UpdateFFmpeg} to Â¬
				display dialog ("è«‹åš«é±«çš„æ²å¥³é°°é¸æ“‡ é¸é …å”·ğŸ’‹") buttons Â¬
					{"MP4è½‰æ›MP3", "é¯æ–° FFmpeg"} default button 1 with title Â¬
					{"YouTubeè¦–é »ä¸‹è¼‰"}
			if UpdateFFmpeg is "MP4è½‰æ›MP3" then run script VideoConversion
			if UpdateFFmpeg is "é¯æ–° FFmpeg" then run script InstallFFmpeg
			
			if VideoDownloadConversion is "é–‹å•Ÿè…³æœ¬" then run script OpenScript
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end run
-----------------------âˆ YouTubeè¦–é »ä¸‹è¼‰ âˆ----------------------------------------ON. 
script YouTubeVideoDownloads
	try
		tell application "Finder"
			set VideoURL to display dialog "è«‹åš«é±«çš„æ²å¥³é°°è²¼ä¸ŠYouTubeè¦–é »ç¶²å€å”·ğŸ’‹" default answer "" buttons {"å—¯å“¼ã€‚ã€‚å¥½çš„å”·ğŸ’‹"} default button 1 with title Â¬
				{"é±«é°°YouTubeè¦–é »ä¸‹è¼‰"}
			set VideoURL to (text returned of result)
			if VideoURL is "" then return continue quit
			set APPitemPath to POSIX path of (path to me as text) Â¬
				& {"Contents/MacOS/youtube-dl"}
			set APPitemPath to quoted form of APPitemPath
			set inBackground to " &> /dev/null &"
			set YouTubeURL to (VideoURL & inBackground)
			set DownloadDestination to quoted form of POSIX path of (choose folder with prompt "è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²ä¸‹è¼‰è‡³å“ªé®•æ–‡ä»¶å¤¾å”·ğŸ’‹")
			(do shell script "cd " & DownloadDestination & ";" & APPitemPath & space & YouTubeURL)
			display notification with title ("è¦–é »æº–å‚™ä¸‹è¼‰ä¸­ï¼Œè«‹ç¨å€™å”·ğŸ’‹")
			delay 1
			set isDone to false
			set itemPath to ("youtube-dl")
			set itemProgress to "ps ax | grep -v grep | grep " & itemPath
			repeat while isDone is false
				try
					do shell script itemProgress
					if the result contains itemPath then
						delay 1
					else
						set isDone to true
					end if
				on error
					set isDone to true
				end try
			end repeat
			if isDone is true then
				display notification with title ("è¦–é »ä¸‹è¼‰é¯‡æˆé°³å”·ğŸ’‹")
				do shell script ("open " & DownloadDestination)
				continue quit
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
----------------------------âˆ ffmpegè½‰æ›é¸é … âˆ----------------------------------------ON. 
script VideoConversion
	try
		tell application "Finder" to set {button returned:ConversionOption} to Â¬
			display dialog {"è«‹åš«é±«çš„æ²å¥³é°°é¸æ“‡ MP4è½‰æ›MP3 é¸é …å”·ğŸ’‹"} buttons Â¬
				{"é±“ä»¶-MP4è½‰æ›ğ©»ŸMP3", "æ‰¹é‡-MP4è½‰æ›ğ©»ŸMP3"} default button 1 with title Â¬
				{"ffmpegè½‰æ›é¸é …"}
		if ConversionOption is "é±“ä»¶-MP4è½‰æ›ğ©»ŸMP3" then run script SinglePiece
		if ConversionOption is "æ‰¹é‡-MP4è½‰æ›ğ©»ŸMP3" then run script BatchConversion
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
-------------------------âˆ é±“ä»¶-MP4è½‰æ›ğ©»ŸMP3 âˆ----------------------------------------ON. 
script SinglePiece
	try
		tell application "Finder"
			set Input to POSIX path of Â¬
				(choose file with prompt ("è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²è½‰æ›ğ©»Ÿ MP3 ä¹‹ æª”æ¡ˆå”·ğŸ’‹"))
			set BitConversion to display dialog ("è«‹åš«é±«çš„æ²å¥³é°°é°é­è½‰æ› ä½å…ƒç‡ å”·ğŸ’‹ 
ä¾‹: 320 256 192 128 64 
é»˜èª 320 å”·ğŸ’‹") default answer ("320") buttons {"å—¯å“¼ã€‚ã€‚å¥½çš„å”·ğŸ’‹"} default button 1 with title Â¬
				{"é±“ä»¶-MP4è½‰æ›ğ©»ŸMP3"}
		end tell
		set BitConversion to (text returned of result)
		if BitConversion is "" then return continue quit
		set APPitemPath to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/ffmpeg"}
		set APPitemPath to quoted form of APPitemPath
		set InputPath to remove_path(Input)
		set InputPath to quoted form of InputPath
		set mk to ("cd " & InputPath & ";mkdir -p _MP3" & ";cd ; ")
		set Output to remove_extension(Input)
		set Output to quoted form of (Output & ".mp3")
		set ConversionParameter to (" -ab " & BitConversion & "k -ac 2 -ar 48000 ")
		set Input to quoted form of Input
		set FFmpegConversion to Â¬
			(APPitemPath & " -nostats -nostdin -n -i " & Input & ConversionParameter & Output)
		set inBackground to " &> /dev/null &"
		set FFmpeg to mk & FFmpegConversion & inBackground
		do shell script FFmpeg
		display notification with title ("è½‰æ›ä¸­ï¼Œè«‹ç¨å€™å”·ğŸ’‹")
		delay 1
		set isDone to false
		set itemPath to ("ffmpeg")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			set MP3_Folder to (InputPath & "/_MP3")
			do shell script ("cd " & InputPath & ";mv *.mp3 " & MP3_Folder & ";cd ;")
			display notification with title ("è½‰æ›é¯‡æˆé°³å”·ğŸ’‹")
			do shell script ("open " & MP3_Folder)
			continue quit
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
	on remove_path(this_name)
		try
			set oldDelims to AppleScript's text item delimiters
			set AppleScript's text item delimiters to {"/"}
			if number of text items of this_name > 1 then
				set this_name to (text items 1 thru -2 of this_name as text)
			end if
			set AppleScript's text item delimiters to oldDelims
		on error
			set AppleScript's text item delimiters to oldDelims
		end try
		return this_name
	end remove_path
	on remove_extension(this_name)
		try
			set oldDelims to AppleScript's text item delimiters
			set AppleScript's text item delimiters to {"."}
			if number of text items of this_name > 1 then
				set this_name to (text items 1 thru -2 of this_name as text)
			end if
			set AppleScript's text item delimiters to oldDelims
		on error
			set AppleScript's text item delimiters to oldDelims
		end try
		return this_name
	end remove_extension
end script
-------------------------âˆ æ‰¹é‡-MP4è½‰æ›ğ©»ŸMP3 âˆ----------------------------------------ON. 
script BatchConversion
	try
		tell application "Finder"
			set Input to Â¬
				(choose folder with prompt "è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²è½‰æ›ğ©»Ÿ MP3 ä¹‹ æ–‡ä»¶å¤¾å”·ğŸ’‹")
			set media to files of entire contents of folder Input
			set BitConversion to display dialog ("è«‹åš«é±«çš„æ²å¥³é°°é°é­è½‰æ› ä½å…ƒç‡ å”·ğŸ’‹ 
ä¾‹: 320 256 192 128 64 
é»˜èª 320 å”·ğŸ’‹") default answer ("320") buttons {"å—¯å“¼ã€‚ã€‚å¥½çš„å”·ğŸ’‹"} default button 1 with title Â¬
				{"æ‰¹é‡-MP4è½‰æ›ğ©»ŸMP3"}
		end tell
		set BitConversion to (text returned of result)
		if BitConversion is "" then return continue quit
		set APPitemPath to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/ffmpeg"}
		set APPitemPath to quoted form of APPitemPath
		set Input1 to POSIX path of Input
		set Input2 to quoted form of Input1
		set mk to ("cd " & Input2 & ";mkdir -p _MP3" & ";cd ; ")
		repeat with i in media
			set fileName to i as string
			set Input to POSIX path of fileName
			set Output to remove_extension(Input)
			set Output to quoted form of (Output & ".mp3")
			set Input to quoted form of Input
			set ConversionParameter to (" -ab " & BitConversion & "k -ac 2 -ar 48000 ")
			set FFmpegConversion to Â¬
				(APPitemPath & " -nostats -nostdin -n -i " & Â¬
					Input & ConversionParameter & Output)
			set inBackground to " &> /dev/null &"
			set FFmpeg to mk & FFmpegConversion & inBackground
			do shell script FFmpeg
		end repeat
		display notification with title ("è½‰æ›ä¸­ï¼Œè«‹ç¨å€™å”·ğŸ’‹")
		delay 1
		set isDone to false
		set itemPath to ("ffmpeg")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			set MP3_Folder to quoted form of (Input1 & "_MP3")
			do shell script ("cd " & Input2 & ";mv *.mp3 " & MP3_Folder & ";cd ;")
			display notification with title ("è½‰æ›é¯‡æˆé°³å”·ğŸ’‹")
			do shell script ("open " & MP3_Folder)
			continue quit
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
	on remove_extension(this_name)
		if this_name contains "." then
			set this_name to Â¬
				(the reverse of every character of this_name) as string
			set x to the offset of "." in this_name
			set this_name to (text (x + 1) thru -1 of this_name)
			set this_name to (the reverse of every character of this_name) as string
		end if
		return this_name
	end remove_extension
end script
------------------------ é¯æ–° YouTube-Dl ------------------------ON. 
script InstallYouTubeDl
	try
		set YouTubeDl_Path to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/youtube-dl"}
		set YouTubeDl_Path to quoted form of YouTubeDl_Path
		(do shell script " 
rm -rf " & YouTubeDl_Path & " ; 
curl -Lk https://yt-dl.org/downloads/latest/youtube-dl -o " & YouTubeDl_Path & " ; 
chmod a+rx " & YouTubeDl_Path & " ; " with administrator privileges)
		delay 1
		set isDone to false
		set itemPath to ("youtube-dl ")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			display notification with title ("é®Ÿè£é¯‡æˆï¼Œé­ºä¸‹è¼‰å½±ç‰‡é°³å”·ğŸ’‹")
			run script YouTubeVideoDownloads -- é‹è¡ŒYouTubeä¸‹è¼‰è…³æœ¬ 
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
------------------------ é¯æ–° ffmpeg ------------------------ON. 
script InstallFFmpeg
	try
		set me_Path to POSIX path of (path to me as text)
		set me_Path to quoted form of me_Path
		
		set MacOS_Path to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/"}
		set MacOS_Path to quoted form of MacOS_Path
		(do shell script " 
	cd " & MacOS_Path & space & " 
	rm -rf ffmpeg ffmpeg-4.4.1.zip;  
curl -O https://evermeet.cx/ffmpeg/ffmpeg-4.4.1.zip ")
		delay 1
		set isDone to false
		set itemPath to ("curl -O https://evermeet.cx/ffmpeg/ffmpeg-4.4.1.zip ")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			(do shell script " 
			cd " & MacOS_Path & space & " 
		open ffmpeg-4.4.1.zip " & space & (delay 1 & " ;) 	 
		 mv " & me_Path & space & me_Path & " ;   
		cd " & MacOS_Path & space & MacOS_Path & ";) 	
		 cd "))
			display notification with title ("é®Ÿè£é¯‡æˆï¼Œé­ºè½‰æ›é°³å”·ğŸ’‹")
			run script VideoConversion -- é‹è¡ŒMP4è½‰æ›MP3è…³æœ¬ 
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
-------------------- é–‹å•Ÿé±«é°°YouTubeè¦–é »ä¸‹è¼‰é±®MP4è½‰æ›MP3è…³æœ¬ ----------------ON. 
script OpenScript
	try
		set OpenAppScript to POSIX path of (path to me as text) & ("Contents/Resources/Scripts/main.scpt")
		set OpenAppScript to quoted form of OpenAppScript
		do shell script ("open " & OpenAppScript)
		display notification with title ("è…³æœ¬å·²é–‹å•Ÿé°³å”·ğŸ’‹")
		continue quit
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
-----------------âˆ é±«é°°YouTubeè¦–é »ä¸‹è¼‰é±®MP4è½‰æ›MP3 âˆ-------------------------END. 


-- 
